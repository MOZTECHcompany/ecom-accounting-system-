// Prisma Schema for E-Commerce Accounting System
// 此 schema 設計支援多公司實體、多幣別、多平台的電商會計系統

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TaxType {
  TAXABLE_5_PERCENT        // V5: 應稅 5% (可扣抵)
  NON_DEDUCTIBLE_5_PERCENT // VND: 應稅 5% (不可扣抵 - 交際費、職工福利等)
  ZERO_RATED               // Z0: 零稅率
  TAX_FREE                 // F0: 免稅/無稅
}

// ============================================
// 1. 系統核心：使用者、角色、權限、審計軌跡
// ============================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  name         String
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  roles                         UserRole[]
  createdJournalEntries         JournalEntry[]                 @relation("CreatedBy")
  approvedJournalEntries        JournalEntry[]                 @relation("ApprovedBy")
  createdExpenseRequests        ExpenseRequest[]               @relation("RequestedBy")
  approvedExpenseRequests       ExpenseRequest[]               @relation("ApprovedBy")
  approvalRequests              ApprovalRequest[]              @relation("RequesterUser")
  approvalsGiven                ApprovalRequest[]              @relation("ApproverUser")
  auditLogs                     AuditLog[]
  payrollRunsCreated            PayrollRun[]                   @relation("CreatedBy")
  payrollRunsApproved           PayrollRun[]                   @relation("ApprovedBy")
  invoiceLogs                   InvoiceLog[]
  bankImportBatches             BankImportBatch[]
  reconciliationResults         ReconciliationResult[]
  approvalPolicySteps           ApprovalPolicyStep[]
  approvalSteps                 ApprovalStep[]
  expenseRequestHistories       ExpenseRequestHistory[]
  accountingClassifierFeedbacks AccountingClassifierFeedback[]
  notifications                 Notification[]

  // Attendance Relations
  employee              Employee?
  reviewedLeaveRequests LeaveRequest[] @relation("LeaveReviewer")
  uploadedLeaveDocuments LeaveDocument[] @relation("LeaveDocumentUploader")
  leaveRequestHistories LeaveRequestHistory[] @relation("LeaveHistoryActor")
  resolvedAnomalies     AttendanceAnomaly[] @relation("AnomalyResolver")
  createdAssemblyOrders AssemblyOrder[]

  @@map("users")
}

model Role {
  id             String   @id @default(uuid())
  code           String   @unique
  name           String   @unique // ADMIN, ACCOUNTANT, OPERATOR
  description    String?
  hierarchyLevel Int      @default(3) @map("hierarchy_level")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  users       UserRole[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  resource    String // users, accounts, journal_entries, sales_orders, etc.
  action      String // create, read, update, delete, approve
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  roles RolePermission[]

  @@unique([resource, action])
  @@map("permissions")
}

model UserRole {
  userId String @map("user_id")
  roleId String @map("role_id")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  roleId       String @map("role_id")
  permissionId String @map("permission_id")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// 審計軌跡：記錄所有重要操作
model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  tableName String   @map("table_name")
  recordId  String   @map("record_id")
  action    String // CREATE, UPDATE, DELETE, APPROVE
  oldData   Json?    @map("old_data")
  newData   Json?    @map("new_data")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tableName, recordId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// 2. 公司實體與會計核心
// ============================================

// 公司實體（支援多公司營運）
model Entity {
  id           String  @id @default(uuid())
  name         String
  country      String // TW, CN, US, etc.
  baseCurrency String  @map("base_currency") // TWD, CNY, USD
  isActive     Boolean @default(true) @map("is_active")
  taxId        String? @map("tax_id")
  address      String?
  contactEmail String? @map("contact_email")
  contactPhone String? @map("contact_phone")

  // Relations
  accounts              Account[]
  journalEntries        JournalEntry[]
  periods               Period[]
  customers             Customer[]
  vendors               Vendor[]
  products              Product[]
  salesChannels         SalesChannel[]
  salesOrders           SalesOrder[]
  arInvoices            ArInvoice[]
  apInvoices            ApInvoice[]
  bankAccounts          BankAccount[]
  departments           Department[]
  employees             Employee[]
  payrollRuns           PayrollRun[]
  expenseRequests       ExpenseRequest[]
  expenses              Expense[]
  purchaseOrders        PurchaseOrder[]
  productBatches        ProductBatch[]
  devCosts              DevCost[]
  shipments             Shipment[]
  payments              Payment[]
  approvalRequests      ApprovalRequest[]
  invoices              Invoice[]
  bankImportBatches     BankImportBatch[]
  warehouses            Warehouse[]
  inventorySnapshots    InventorySnapshot[]
  inventoryTransactions InventoryTransaction[]
  reimbursementItems    ReimbursementItem[]
  approvalPolicies      ApprovalPolicy[]
  paymentTasks          PaymentTask[]
  classifierFeedbacks   AccountingClassifierFeedback[] @relation("EntityClassifierFeedback")

  // Attendance Relations
  attendancePolicies    AttendancePolicy[]
  attendanceRecords     AttendanceRecord[]
  attendanceSummaries   AttendanceDailySummary[]
  leaveTypes            LeaveType[]
  leaveBalances         LeaveBalance[]
  leaveRequests         LeaveRequest[]
  attendanceAnomalies   AttendanceAnomaly[]
  inventorySerialNumbers InventorySerialNumber[]
  billOfMaterials       BillOfMaterial[]
  assemblyOrders        AssemblyOrder[]

  @@map("entities")
}

// 會計科目表
model Account {
  id             String   @id @default(uuid())
  entityId       String   @map("entity_id")
  code           String // 科目代號，例如 1101, 4101
  name           String // 科目名稱，例如 現金、銷貨收入
  type           String // asset, liability, equity, revenue, expense
  parentId       String?  @map("parent_id")
  isActive       Boolean  @default(true) @map("is_active")
  isReimbursable Boolean  @default(false) @map("is_reimbursable")
  description    String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  entity                       Entity                         @relation(fields: [entityId], references: [id], onDelete: Cascade)
  parent                       Account?                       @relation("AccountHierarchy", fields: [parentId], references: [id])
  children                     Account[]                      @relation("AccountHierarchy")
  journalLines                 JournalLine[]
  reimbursementItems           ReimbursementItem[]
  suggestedExpenseRequests     ExpenseRequest[]               @relation("ExpenseRequestSuggestedAccount")
  finalExpenseRequests         ExpenseRequest[]               @relation("ExpenseRequestFinalAccount")
  historySuggestedAccounts     ExpenseRequestHistory[]        @relation("HistorySuggestedAccount")
  historyFinalAccounts         ExpenseRequestHistory[]        @relation("HistoryFinalAccount")
  classifierSuggestedFeedbacks AccountingClassifierFeedback[] @relation("ClassifierSuggestedAccount")
  classifierChosenFeedbacks    AccountingClassifierFeedback[] @relation("ClassifierChosenAccount")
  paymentTasks                 PaymentTask[]

  @@unique([entityId, code])
  @@index([entityId, type])
  @@map("accounts")
}

// 會計期間（支援鎖帳機制）
model Period {
  id        String   @id @default(uuid())
  entityId  String   @map("entity_id")
  name      String // 2025-01
  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")
  status    String   @default("open") // open, closed, locked
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  entity         Entity         @relation(fields: [entityId], references: [id], onDelete: Cascade)
  journalEntries JournalEntry[]

  @@unique([entityId, name])
  @@index([entityId, status])
  @@map("periods")
}

// 會計分錄主檔
model JournalEntry {
  id           String    @id @default(uuid())
  entityId     String    @map("entity_id")
  date         DateTime
  description  String
  sourceModule String?   @map("source_module") // sales, purchase, payroll, banking, manual
  sourceId     String?   @map("source_id") // 來源單據 ID
  periodId     String?   @map("period_id")
  createdBy    String    @map("created_by")
  approvedBy   String?   @map("approved_by")
  approvedAt   DateTime? @map("approved_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  entity       Entity        @relation(fields: [entityId], references: [id], onDelete: Cascade)
  period       Period?       @relation(fields: [periodId], references: [id])
  creator      User          @relation("CreatedBy", fields: [createdBy], references: [id])
  approver     User?         @relation("ApprovedBy", fields: [approvedBy], references: [id])
  journalLines JournalLine[]

  @@index([entityId, date])
  @@index([sourceModule, sourceId])
  @@map("journal_entries")
}

// 會計分錄明細
model JournalLine {
  id             String  @id @default(uuid())
  journalEntryId String  @map("journal_entry_id")
  accountId      String  @map("account_id")
  debit          Decimal @default(0) @db.Decimal(18, 2)
  credit         Decimal @default(0) @db.Decimal(18, 2)
  currency       String  @default("TWD")
  fxRate         Decimal @default(1) @map("fx_rate") @db.Decimal(18, 6)
  amountBase     Decimal @map("amount_base") @db.Decimal(18, 2) // 本位幣金額
  memo           String?

  journalEntry JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account      Account      @relation(fields: [accountId], references: [id])

  @@index([journalEntryId])
  @@index([accountId])
  @@map("journal_lines")
}

// ============================================
// 3. 銷售與客戶管理
// ============================================

// 銷售渠道（平台）
model SalesChannel {
  id              String  @id @default(uuid())
  entityId        String  @map("entity_id")
  name            String // Shopify 官網、1shop、momo 等
  code            String // SHOPIFY, 1SHOP, MOMO, PCHOME, SHOPEE, COUPANG, SHOPLINE, AMAZON, TTSHOP
  type            String // own_site, marketplace, group_buy, distributor, social_commerce
  defaultCurrency String  @default("TWD") @map("default_currency")
  configJson      Json?   @map("config_json") // 儲存 API keys, webhook URLs 等
  isActive        Boolean @default(true) @map("is_active")

  entity      Entity       @relation(fields: [entityId], references: [id], onDelete: Cascade)
  salesOrders SalesOrder[]
  payments    Payment[]

  @@unique([entityId, code])
  @@map("sales_channels")
}

// 客戶
model Customer {
  id        String   @id @default(uuid())
  entityId  String   @map("entity_id")
  name      String
  email     String?
  phone     String?
  taxId     String?  @map("tax_id")
  type      String   @default("individual") // individual, company
  address   String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  entity      Entity       @relation(fields: [entityId], references: [id], onDelete: Cascade)
  salesOrders SalesOrder[]
  arInvoices  ArInvoice[]

  @@index([entityId])
  @@map("customers")
}

// 供應商
model Vendor {
  id              String   @id @default(uuid())
  entityId        String   @map("entity_id")
  name            String
  country         String?
  defaultCurrency String?  @default("TWD") @map("default_currency")
  taxId           String?  @map("tax_id")
  bankInfo        Json?    @map("bank_info")
  contactPerson   String?  @map("contact_person")
  contactEmail    String?  @map("contact_email")
  contactPhone    String?  @map("contact_phone")
  address         String?
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  entity         Entity          @relation(fields: [entityId], references: [id], onDelete: Cascade)
  purchaseOrders PurchaseOrder[]
  apInvoices     ApInvoice[]
  paymentTasks   PaymentTask[]

  @@index([entityId])
  @@map("vendors")
}

// 商品類型
enum ProductType {
  SIMPLE        // 一般商品
  BUNDLE        // 組合商品 (虛擬，扣子件庫存)
  MANUFACTURED  // 製成品 (需組裝，有 BOM)
  SERVICE       // 服務 (無庫存)
}

// 商品
model Product {
  id          String      @id @default(uuid())
  entityId    String      @map("entity_id")
  sku         String
  name        String
  type        ProductType @default(SIMPLE)
  category    String?
  description String?
  
  // 價格與成本
  salesPrice  Decimal     @default(0) @map("sales_price") @db.Decimal(18, 2)
  purchaseCost Decimal    @default(0) @map("purchase_cost") @db.Decimal(18, 2)

  isActive    Boolean     @default(true) @map("is_active")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  entity             Entity                 @relation(fields: [entityId], references: [id], onDelete: Cascade)
  salesOrderItems    SalesOrderItem[]
  purchaseOrderItems PurchaseOrderItem[]
  productBatches     ProductBatch[]
  devCosts           DevCost[]
  invoiceLines       InvoiceLine[]
  inventorySnapshots InventorySnapshot[]
  inventoryMovements InventoryTransaction[]
  
  // BOM Relations
  bomParent          BillOfMaterial[]       @relation("BomParent")
  bomChildren        BillOfMaterial[]       @relation("BomChild")
  
  // Assembly Relations
  assemblyOrders     AssemblyOrder[]        @relation("AssemblyProduct")

  // Costing & Tracking
  hasSerialNumbers   Boolean                @default(false) @map("has_serial_numbers")
  movingAverageCost  Decimal                @default(0) @map("moving_average_cost") @db.Decimal(18, 4)
  latestPurchasePrice Decimal               @default(0) @map("latest_purchase_price") @db.Decimal(18, 4)

  // Variant Support
  parentId           String?                @map("parent_id")
  attributes         Json?                  @map("attributes") // e.g. { "Color": "Red", "Size": "L" }
  
  // Barcode & Identification
  barcode            String?                @map("barcode") // International Barcode (EAN/UPC)
  modelNumber        String?                @map("model_number") // Manufacturer Part Number (MPN) / Model No.
  hsCode             String?                @map("hs_code") // Harmonized System Code
  countryOfOrigin    String?                @map("country_of_origin") // ISO 3166-1 alpha-2 code

  // Physical Dimensions & Weight
  packageLength      Decimal?               @map("package_length") @db.Decimal(10, 2) // cm
  packageWidth       Decimal?               @map("package_width") @db.Decimal(10, 2) // cm
  packageHeight      Decimal?               @map("package_height") @db.Decimal(10, 2) // cm
  grossWeight        Decimal?               @map("gross_weight") @db.Decimal(10, 3) // kg
  netWeight          Decimal?               @map("net_weight") @db.Decimal(10, 3) // kg

  parent             Product?               @relation("ProductVariants", fields: [parentId], references: [id])
  variants           Product[]              @relation("ProductVariants")

  serialNumbers      InventorySerialNumber[]

  @@unique([entityId, sku])
  @@index([entityId])
  @@index([parentId])
  @@map("products")
}

// 庫存序號追蹤 (SN)
model InventorySerialNumber {
  id          String   @id @default(uuid())
  entityId    String   @map("entity_id")
  productId   String   @map("product_id")
  warehouseId String?  @map("warehouse_id") // 如果已出貨，可能為 null 或特定「已出貨」倉
  serialNumber String  @map("serial_number")
  status      String   @default("AVAILABLE") // AVAILABLE, RESERVED, SOLD, DEFECTIVE, RETURNED
  
  // 追蹤資訊
  inboundRefType  String? @map("inbound_ref_type") // PURCHASE_ORDER, ASSEMBLY
  inboundRefId    String? @map("inbound_ref_id")
  outboundRefType String? @map("outbound_ref_type") // SALES_ORDER, ASSEMBLY
  outboundRefId   String? @map("outbound_ref_id")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  entity    Entity     @relation(fields: [entityId], references: [id], onDelete: Cascade)
  product   Product    @relation(fields: [productId], references: [id])
  warehouse Warehouse? @relation(fields: [warehouseId], references: [id])

  @@unique([entityId, productId, serialNumber])
  @@index([serialNumber])
  @@index([status])
  @@map("inventory_serial_numbers")
}

// 物料清單 (BOM)
model BillOfMaterial {
  id          String   @id @default(uuid())
  entityId    String   @map("entity_id")
  parentId    String   @map("parent_id") // 父商品 (Bundle or Manufactured)
  childId     String   @map("child_id")  // 子商品 (Component)
  quantity    Decimal  @db.Decimal(18, 4) // 每個父商品需要多少子商品
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  entity      Entity   @relation(fields: [entityId], references: [id], onDelete: Cascade)
  parent      Product  @relation("BomParent", fields: [parentId], references: [id], onDelete: Cascade)
  child       Product  @relation("BomChild", fields: [childId], references: [id])

  @@unique([parentId, childId])
  @@index([parentId])
  @@map("bill_of_materials")
}

// 組裝/拆解單
model AssemblyOrder {
  id          String   @id @default(uuid())
  entityId    String   @map("entity_id")
  orderNo     String   @unique @map("order_no")
  productId   String   @map("product_id") // 要生產/拆解的商品
  warehouseId String   @map("warehouse_id")
  quantity    Decimal  @db.Decimal(18, 2)
  type        String   @default("ASSEMBLE") // ASSEMBLE (組裝), DISASSEMBLE (拆解)
  status      String   @default("DRAFT")    // DRAFT, CONFIRMED, COMPLETED, CANCELLED
  
  // 成本相關
  totalCostBase Decimal @default(0) @map("total_cost_base") @db.Decimal(18, 2)
  
  notes       String?
  occurredAt  DateTime @default(now()) @map("occurred_at")
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  entity      Entity   @relation(fields: [entityId], references: [id], onDelete: Cascade)
  product     Product  @relation("AssemblyProduct", fields: [productId], references: [id])
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  creator     User     @relation(fields: [createdBy], references: [id])

  @@index([entityId, status])
  @@map("assembly_orders")
}

// 倉庫（多倉管理：公司倉、3PL、平台倉等）
model Warehouse {
  id        String   @id @default(uuid())
  entityId  String   @map("entity_id")
  code      String
  name      String
  type      String   @default("INTERNAL") // INTERNAL, 3PL, PLATFORM
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  entity    Entity                 @relation(fields: [entityId], references: [id], onDelete: Cascade)
  snapshots InventorySnapshot[]
  movements InventoryTransaction[]
  inventorySerialNumbers InventorySerialNumber[]
  assemblyOrders AssemblyOrder[]

  @@unique([entityId, code])
  @@index([entityId])
  @@map("warehouses")
}

// 庫存快照（每商品/每倉庫一筆，紀錄 OnHand/Allocated/Available）
model InventorySnapshot {
  id          String @id @default(uuid())
  entityId    String @map("entity_id")
  warehouseId String @map("warehouse_id")
  productId   String @map("product_id")

  qtyOnHand    Decimal @default(0) @map("qty_on_hand") @db.Decimal(18, 2)
  qtyAllocated Decimal @default(0) @map("qty_allocated") @db.Decimal(18, 2)
  qtyAvailable Decimal @default(0) @map("qty_available") @db.Decimal(18, 2)

  updatedAt DateTime @updatedAt @map("updated_at")

  entity    Entity    @relation(fields: [entityId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])
  product   Product   @relation(fields: [productId], references: [id])

  @@unique([entityId, warehouseId, productId])
  @@index([productId])
  @@map("inventory_snapshots")
}

// 庫存異動流水（入庫/出庫/預留/釋放/調整）
model InventoryTransaction {
  id            String   @id @default(uuid())
  entityId      String   @map("entity_id")
  warehouseId   String   @map("warehouse_id")
  productId     String   @map("product_id")
  direction     String // IN, OUT, RESERVE, RELEASE, ADJUST
  quantity      Decimal  @map("quantity") @db.Decimal(18, 2)
  referenceType String // PURCHASE_ORDER, SALES_ORDER, ADJUSTMENT, STOCK_TAKE 等
  referenceId   String?  @map("reference_id")
  reason        String?
  occurredAt    DateTime @map("occurred_at")
  createdAt     DateTime @default(now()) @map("created_at")

  entity    Entity    @relation(fields: [entityId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])
  product   Product   @relation(fields: [productId], references: [id])

  @@index([entityId, warehouseId, productId])
  @@index([referenceType, referenceId])
  @@map("inventory_transactions")
}

// 銷售訂單
model SalesOrder {
  id              String   @id @default(uuid())
  entityId        String   @map("entity_id")
  channelId       String   @map("channel_id")
  customerId      String?  @map("customer_id")
  externalOrderId String?  @map("external_order_id") // 平台訂單編號
  orderDate       DateTime @map("order_date")

  // 訂單總額（符合四欄位標準）
  totalGrossOriginal Decimal @map("total_gross_original") @db.Decimal(18, 2)
  totalGrossCurrency String  @default("TWD") @map("total_gross_currency")
  totalGrossFxRate   Decimal @default(1) @map("total_gross_fx_rate") @db.Decimal(18, 6)
  totalGrossBase     Decimal @map("total_gross_base") @db.Decimal(18, 2)

  // 稅額（符合四欄位標準）
  taxAmountOriginal Decimal @default(0) @map("tax_amount_original") @db.Decimal(18, 2)
  taxAmountCurrency String  @default("TWD") @map("tax_amount_currency")
  taxAmountFxRate   Decimal @default(1) @map("tax_amount_fx_rate") @db.Decimal(18, 6)
  taxAmountBase     Decimal @default(0) @map("tax_amount_base") @db.Decimal(18, 2)

  // 折扣金額（符合四欄位標準）
  discountAmountOriginal Decimal @default(0) @map("discount_amount_original") @db.Decimal(18, 2)
  discountAmountCurrency String  @default("TWD") @map("discount_amount_currency")
  discountAmountFxRate   Decimal @default(1) @map("discount_amount_fx_rate") @db.Decimal(18, 6)
  discountAmountBase     Decimal @default(0) @map("discount_amount_base") @db.Decimal(18, 2)

  // 運費（符合四欄位標準）
  shippingFeeOriginal Decimal  @default(0) @map("shipping_fee_original") @db.Decimal(18, 2)
  shippingFeeCurrency String   @default("TWD") @map("shipping_fee_currency")
  shippingFeeFxRate   Decimal  @default(1) @map("shipping_fee_fx_rate") @db.Decimal(18, 6)
  shippingFeeBase     Decimal  @default(0) @map("shipping_fee_base") @db.Decimal(18, 2)
  status              String   @default("pending") // pending, shipped, completed, cancelled, refunded
  hasInvoice          Boolean  @default(false) @map("has_invoice")
  invoiceId           String?  @map("invoice_id")
  notes               String?
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  entity    Entity           @relation(fields: [entityId], references: [id], onDelete: Cascade)
  channel   SalesChannel     @relation(fields: [channelId], references: [id])
  customer  Customer?        @relation(fields: [customerId], references: [id])
  items     SalesOrderItem[]
  shipments Shipment[]
  payments  Payment[]
  invoices  Invoice[]

  @@index([entityId, orderDate])
  @@index([channelId])
  @@index([status])
  @@map("sales_orders")
}

// 銷售訂單明細
model SalesOrderItem {
  id           String  @id @default(uuid())
  salesOrderId String  @map("sales_order_id")
  productId    String  @map("product_id")
  qty          Decimal @db.Decimal(18, 2)

  // 單價（符合四欄位標準）
  unitPriceOriginal Decimal @map("unit_price_original") @db.Decimal(18, 2)
  unitPriceCurrency String  @default("TWD") @map("unit_price_currency")
  unitPriceFxRate   Decimal @default(1) @map("unit_price_fx_rate") @db.Decimal(18, 6)
  unitPriceBase     Decimal @map("unit_price_base") @db.Decimal(18, 2)

  // 折扣（符合四欄位標準）
  discountOriginal Decimal @default(0) @map("discount_original") @db.Decimal(18, 2)
  discountCurrency String  @default("TWD") @map("discount_currency")
  discountFxRate   Decimal @default(1) @map("discount_fx_rate") @db.Decimal(18, 6)
  discountBase     Decimal @default(0) @map("discount_base") @db.Decimal(18, 2)

  // 稅額（符合四欄位標準）
  taxAmountOriginal Decimal @default(0) @map("tax_amount_original") @db.Decimal(18, 2)
  taxAmountCurrency String  @default("TWD") @map("tax_amount_currency")
  taxAmountFxRate   Decimal @default(1) @map("tax_amount_fx_rate") @db.Decimal(18, 6)
  taxAmountBase     Decimal @default(0) @map("tax_amount_base") @db.Decimal(18, 2)

  salesOrder SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id])

  @@index([salesOrderId])
  @@map("sales_order_items")
}

// 出貨紀錄
model Shipment {
  id           String   @id @default(uuid())
  entityId     String   @map("entity_id")
  salesOrderId String   @map("sales_order_id")
  shipDate     DateTime @map("ship_date")
  trackingNo   String?  @map("tracking_no")
  carrier      String?
  status       String   @default("shipped") // shipped, delivered, returned
  notes        String?
  createdAt    DateTime @default(now()) @map("created_at")

  entity     Entity     @relation(fields: [entityId], references: [id], onDelete: Cascade)
  salesOrder SalesOrder @relation(fields: [salesOrderId], references: [id])

  @@index([salesOrderId])
  @@map("shipments")
}

// 收款紀錄（平台撥款／金流實收）
model Payment {
  id            String   @id @default(uuid())
  entityId      String   @map("entity_id")
  salesOrderId  String?  @map("sales_order_id")
  channelId     String?  @map("channel_id")
  payoutBatchId String?  @map("payout_batch_id") // 平台批次撥款 ID
  channel       String // ECPAY, SHOPIFY_PAYOUT, MOMO_PAYOUT, BANK_TRANSFER, etc.
  payoutDate    DateTime @map("payout_date")

  // 總收款（符合四欄位標準）
  amountGrossOriginal Decimal @map("amount_gross_original") @db.Decimal(18, 2)
  amountGrossCurrency String  @default("TWD") @map("amount_gross_currency")
  amountGrossFxRate   Decimal @default(1) @map("amount_gross_fx_rate") @db.Decimal(18, 6)
  amountGrossBase     Decimal @map("amount_gross_base") @db.Decimal(18, 2)

  // 平台費（符合四欄位標準）
  feePlatformOriginal Decimal @default(0) @map("fee_platform_original") @db.Decimal(18, 2)
  feePlatformCurrency String  @default("TWD") @map("fee_platform_currency")
  feePlatformFxRate   Decimal @default(1) @map("fee_platform_fx_rate") @db.Decimal(18, 6)
  feePlatformBase     Decimal @default(0) @map("fee_platform_base") @db.Decimal(18, 2)

  // 金流手續費（符合四欄位標準）
  feeGatewayOriginal Decimal @default(0) @map("fee_gateway_original") @db.Decimal(18, 2)
  feeGatewayCurrency String  @default("TWD") @map("fee_gateway_currency")
  feeGatewayFxRate   Decimal @default(1) @map("fee_gateway_fx_rate") @db.Decimal(18, 6)
  feeGatewayBase     Decimal @default(0) @map("fee_gateway_base") @db.Decimal(18, 2)

  // 運費（符合四欄位標準）
  shippingFeePaidOriginal Decimal @default(0) @map("shipping_fee_paid_original") @db.Decimal(18, 2)
  shippingFeePaidCurrency String  @default("TWD") @map("shipping_fee_paid_currency")
  shippingFeePaidFxRate   Decimal @default(1) @map("shipping_fee_paid_fx_rate") @db.Decimal(18, 6)
  shippingFeePaidBase     Decimal @default(0) @map("shipping_fee_paid_base") @db.Decimal(18, 2)

  // 實收淨額（符合四欄位標準）
  amountNetOriginal Decimal  @map("amount_net_original") @db.Decimal(18, 2)
  amountNetCurrency String   @default("TWD") @map("amount_net_currency")
  amountNetFxRate   Decimal  @default(1) @map("amount_net_fx_rate") @db.Decimal(18, 6)
  amountNetBase     Decimal  @map("amount_net_base") @db.Decimal(18, 2)
  bankAccountId     String?  @map("bank_account_id")
  reconciledFlag    Boolean  @default(false) @map("reconciled_flag")
  status            String   @default("pending") // pending, completed, failed
  notes             String?
  createdAt         DateTime @default(now()) @map("created_at")

  entity       Entity        @relation(fields: [entityId], references: [id], onDelete: Cascade)
  salesOrder   SalesOrder?   @relation(fields: [salesOrderId], references: [id])
  salesChannel SalesChannel? @relation(fields: [channelId], references: [id])
  bankAccount  BankAccount?  @relation(fields: [bankAccountId], references: [id])

  @@index([entityId, payoutDate])
  @@index([salesOrderId])
  @@map("payments")
}

// ============================================
// 4. 應收應付管理
// ============================================

// 應收帳款
model ArInvoice {
  id         String  @id @default(uuid())
  entityId   String  @map("entity_id")
  customerId String? @map("customer_id")
  invoiceNo  String? @map("invoice_no")

  // 應收金額（符合四欄位標準）
  amountOriginal Decimal @map("amount_original") @db.Decimal(18, 2)
  amountCurrency String  @default("TWD") @map("amount_currency")
  amountFxRate   Decimal @default(1) @map("amount_fx_rate") @db.Decimal(18, 6)
  amountBase     Decimal @map("amount_base") @db.Decimal(18, 2)

  // 已收金額（符合四欄位標準）
  paidAmountOriginal Decimal @default(0) @map("paid_amount_original") @db.Decimal(18, 2)
  paidAmountCurrency String  @default("TWD") @map("paid_amount_currency")
  paidAmountFxRate   Decimal @default(1) @map("paid_amount_fx_rate") @db.Decimal(18, 6)
  paidAmountBase     Decimal @default(0) @map("paid_amount_base") @db.Decimal(18, 2)

  issueDate    DateTime @map("issue_date")
  dueDate      DateTime @map("due_date")
  status       String   @default("unpaid") // unpaid, partial, paid, overdue, written_off
  priority     String   @default("normal") // normal, urgent
  sourceModule String?  @map("source_module")
  sourceId     String?  @map("source_id")
  notes        String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  entity   Entity    @relation(fields: [entityId], references: [id], onDelete: Cascade)
  customer Customer? @relation(fields: [customerId], references: [id])

  @@index([entityId, status])
  @@index([dueDate])
  @@map("ar_invoices")
}

// 應付帳款
model ApInvoice {
  id        String  @id @default(uuid())
  entityId  String  @map("entity_id")
  vendorId  String? @map("vendor_id")
  invoiceNo String? @map("invoice_no")

  // 應付金額（符合四欄位標準）
  amountOriginal Decimal @map("amount_original") @db.Decimal(18, 2)
  amountCurrency String  @default("TWD") @map("amount_currency")
  amountFxRate   Decimal @default(1) @map("amount_fx_rate") @db.Decimal(18, 6)
  amountBase     Decimal @map("amount_base") @db.Decimal(18, 2)

  invoiceDate DateTime @map("invoice_date")
  dueDate     DateTime @map("due_date")
  nextDueDate DateTime? @map("next_due_date")

  // 已付金額（符合四欄位標準）
  paidAmountOriginal Decimal  @default(0) @map("paid_amount_original") @db.Decimal(18, 2)
  paidAmountCurrency String   @default("TWD") @map("paid_amount_currency")
  paidAmountFxRate   Decimal  @default(1) @map("paid_amount_fx_rate") @db.Decimal(18, 6)
  paidAmountBase     Decimal  @default(0) @map("paid_amount_base") @db.Decimal(18, 2)
  
  taxType            TaxType  @default(TAXABLE_5_PERCENT) @map("tax_type")
  taxAmount          Decimal? @map("tax_amount") @db.Decimal(18, 2)

  status             String   @default("pending") // pending, partial, paid, overdue
  priority           String   @default("normal") // normal, urgent
  paymentFrequency   String   @default("one_time") @map("payment_frequency") // one_time, monthly
  isRecurringMonthly Boolean  @default(false) @map("is_recurring_monthly")
  recurringDayOfMonth Int?    @map("recurring_day_of_month")
  sourceModule       String?  @map("source_module")
  sourceId           String?  @map("source_id")
  approvalStatus     String   @default("pending") @map("approval_status") // pending, approved, rejected
  notes              String?
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  entity Entity  @relation(fields: [entityId], references: [id], onDelete: Cascade)
  vendor Vendor? @relation(fields: [vendorId], references: [id])

  @@index([entityId, status])
  @@index([dueDate])
  @@index([approvalStatus])
  @@map("ap_invoices")
}

// ============================================
// 5. 費用申請與審核
// ============================================

// 費用申請單
model ExpenseRequest {
  id                  String  @id @default(uuid())
  entityId            String  @map("entity_id")
  payeeType           String? @map("payee_type") // employee, vendor
  vendorId            String? @map("vendor_id")
  reimbursementItemId String? @map("reimbursement_item_id")
  suggestedItemId     String? @map("suggested_item_id")

  // 費用金額（符合四欄位標準）
  amountOriginal Decimal @map("amount_original") @db.Decimal(18, 2)
  amountCurrency String  @default("TWD") @map("amount_currency")
  amountFxRate   Decimal @default(1) @map("amount_fx_rate") @db.Decimal(18, 6)
  amountBase     Decimal @map("amount_base") @db.Decimal(18, 2)

  taxType        TaxType  @default(TAXABLE_5_PERCENT) @map("tax_type")
  taxAmount      Decimal? @map("tax_amount") @db.Decimal(18, 2)

  dueDate              DateTime? @map("due_date")
  description          String
  remarks              String?   @map("remarks")
  priority             String    @default("normal") // normal, urgent
  attachmentUrl        String?   @map("attachment_url")
  evidenceFiles        Json?     @map("evidence_files")
  departmentId         String?   @map("department_id")
  receiptType          String?   @map("receipt_type")
  createdBy            String    @map("created_by")
  status               String    @default("pending") // draft, pending, approved, rejected, paid
  approvalUserId       String?   @map("approval_user_id")
  approvedAt           DateTime? @map("approved_at")

  // 付款資訊
  paymentMethod        String?   @map("payment_method") // cash, bank_transfer, check, other
  paymentStatus        String    @default("pending") @map("payment_status") // pending, processing, paid
  paymentBankName      String?   @map("payment_bank_name") // 實際付款銀行名稱
  paymentAccountLast5  String?   @map("payment_account_last_5") // 實際付款帳號末五碼

  suggestedAccountId   String?   @map("suggested_account_id")
  finalAccountId       String?   @map("final_account_id")
  suggestionConfidence Decimal   @default(0) @map("suggestion_confidence") @db.Decimal(5, 2)
  metadata             Json?     @map("metadata")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  entity              Entity                         @relation(fields: [entityId], references: [id], onDelete: Cascade)
  creator             User                           @relation("RequestedBy", fields: [createdBy], references: [id])
  approver            User?                          @relation("ApprovedBy", fields: [approvalUserId], references: [id])
  department          Department?                    @relation(fields: [departmentId], references: [id])
  reimbursementItem   ReimbursementItem?             @relation("ExpenseRequestFinalItem", fields: [reimbursementItemId], references: [id], onDelete: SetNull)
  suggestedItem       ReimbursementItem?             @relation("ExpenseRequestSuggestedItem", fields: [suggestedItemId], references: [id], onDelete: SetNull)
  suggestedAccount    Account?                       @relation("ExpenseRequestSuggestedAccount", fields: [suggestedAccountId], references: [id], onDelete: SetNull)
  finalAccount        Account?                       @relation("ExpenseRequestFinalAccount", fields: [finalAccountId], references: [id], onDelete: SetNull)
  histories           ExpenseRequestHistory[]
  approvalSteps       ApprovalStep[]
  paymentTasks        PaymentTask[]
  classifierFeedbacks AccountingClassifierFeedback[]

  @@index([entityId, status])
  @@index([createdBy])
  @@index([reimbursementItemId])
  @@index([suggestedItemId])
  @@index([suggestedAccountId])
  @@index([finalAccountId])
  @@map("expense_requests")
}

// 費用紀錄（正式入帳）
model Expense {
  id          String   @id @default(uuid())
  entityId    String   @map("entity_id")
  expenseDate DateTime @map("expense_date")

  // 總費用（符合四欄位標準）
  totalAmountOriginal Decimal @map("total_amount_original") @db.Decimal(18, 2)
  totalAmountCurrency String  @default("TWD") @map("total_amount_currency")
  totalAmountFxRate   Decimal @default(1) @map("total_amount_fx_rate") @db.Decimal(18, 6)
  totalAmountBase     Decimal @map("total_amount_base") @db.Decimal(18, 2)

  description  String
  sourceModule String?  @map("source_module")
  sourceId     String?  @map("source_id")
  createdAt    DateTime @default(now()) @map("created_at")

  entity Entity        @relation(fields: [entityId], references: [id], onDelete: Cascade)
  items  ExpenseItem[]

  @@index([entityId, expenseDate])
  @@map("expenses")
}

// 費用明細（可對應不同科目）
model ExpenseItem {
  id          String  @id @default(uuid())
  expenseId   String  @map("expense_id")
  accountCode String? @map("account_code") // 費用科目代號

  // 費用金額（符合四欄位標準）
  amountOriginal Decimal @map("amount_original") @db.Decimal(18, 2)
  amountCurrency String  @default("TWD") @map("amount_currency")
  amountFxRate   Decimal @default(1) @map("amount_fx_rate") @db.Decimal(18, 6)
  amountBase     Decimal @map("amount_base") @db.Decimal(18, 2)

  description String?

  expense Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  @@index([expenseId])
  @@map("expense_items")
}

// 費用報銷模板（員工看到的「選項」，對應實際會計科目）
model ReimbursementItem {
  id                     String   @id @default(uuid())
  entityId               String   @map("entity_id")
  name                   String // 給員工看的名稱，例如：出差旅費、樣品採購（內部）
  description            String?
  accountId              String   @map("account_id") // 對應 accounts 表的實際科目
  isActive               Boolean  @default(true) @map("is_active")
  keywords               String?  @map("keywords")
  amountLimit            Decimal? @map("amount_limit") @db.Decimal(18, 2)
  requiresDepartmentHead Boolean  @default(false) @map("requires_department_head")
  approverRoleCodes      String?  @map("approver_role_codes")
  approvalPolicyId       String?  @map("approval_policy_id")
  defaultReceiptType     String?  @map("default_receipt_type")
  // 權限與使用限制（簡化版，後續可再拆角色／部門對照表）
  allowedRoles           String?  @map("allowed_roles") // 逗號分隔角色代碼，例如 "ADMIN,ACCOUNTANT"
  allowedDepartments     String?  @map("allowed_departments") // 逗號分隔部門 Id 或代碼
  // 憑證要求：TAX_INVOICE, RECEIPT, BANK_SLIP, INTERNAL_ONLY
  allowedReceiptTypes    String?  @map("allowed_receipt_types")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  entity                     Entity           @relation(fields: [entityId], references: [id], onDelete: Cascade)
  account                    Account          @relation(fields: [accountId], references: [id])
  approvalPolicy             ApprovalPolicy?  @relation(fields: [approvalPolicyId], references: [id], onDelete: SetNull)
  defaultTaxType             TaxType          @default(TAXABLE_5_PERCENT) @map("default_tax_type")
  expenseRequests            ExpenseRequest[] @relation("ExpenseRequestFinalItem")
  suggestedExpenseRequests   ExpenseRequest[] @relation("ExpenseRequestSuggestedItem")
  suggestedFeedbacks AccountingClassifierFeedback[] @relation("FeedbackSuggestedItem")
  chosenFeedbacks    AccountingClassifierFeedback[] @relation("FeedbackChosenItem")

  @@unique([entityId, name])
  @@index([entityId, isActive])
  @@index([accountId])
  @@index([approvalPolicyId])
  @@map("reimbursement_items")
}

// 審批政策：定義金額門檻與簽核層級
model ApprovalPolicy {
  id          String   @id @default(uuid())
  entityId    String   @map("entity_id")
  name        String
  description String?
  policyType  String   @default("amount_threshold") @map("policy_type")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  entity Entity               @relation(fields: [entityId], references: [id], onDelete: Cascade)
  steps  ApprovalPolicyStep[]
  items  ReimbursementItem[]
  leaveTypes LeaveType[]

  @@index([entityId, isActive])
  @@map("approval_policies")
}

// 審批政策的每個步驟定義
model ApprovalPolicyStep {
  id                     String   @id @default(uuid())
  approvalPolicyId       String   @map("approval_policy_id")
  stepOrder              Int      @map("step_order")
  minAmount              Decimal? @map("min_amount") @db.Decimal(18, 2)
  maxAmount              Decimal? @map("max_amount") @db.Decimal(18, 2)
  approverRoleCode       String?  @map("approver_role_code")
  requiresDepartmentHead Boolean  @default(false) @map("requires_department_head")
  fallbackUserId         String?  @map("fallback_user_id")
  note                   String?
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  approvalPolicy ApprovalPolicy @relation(fields: [approvalPolicyId], references: [id], onDelete: Cascade)
  fallbackUser   User?          @relation(fields: [fallbackUserId], references: [id])

  @@index([approvalPolicyId])
  @@map("approval_policy_steps")
}

// 實際費用申請的審批節點
model ApprovalStep {
  id               String    @id @default(uuid())
  expenseRequestId String    @map("expense_request_id")
  stepOrder        Int       @map("step_order")
  status           String    @default("pending")
  approverRoleCode String?   @map("approver_role_code")
  approverUserId   String?   @map("approver_user_id")
  departmentId     String?   @map("department_id")
  amountThreshold  Decimal?  @map("amount_threshold") @db.Decimal(18, 2)
  assignedAt       DateTime? @map("assigned_at")
  decidedAt        DateTime? @map("decided_at")
  remark           String?
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  expenseRequest ExpenseRequest @relation(fields: [expenseRequestId], references: [id], onDelete: Cascade)
  approverUser   User?          @relation(fields: [approverUserId], references: [id])
  department     Department?    @relation(fields: [departmentId], references: [id])

  @@index([expenseRequestId, stepOrder])
  @@index([status])
  @@map("approval_steps")
}

// 費用申請歷程紀錄
model ExpenseRequestHistory {
  id                 String   @id @default(uuid())
  expenseRequestId   String   @map("expense_request_id")
  action             String
  fromStatus         String?  @map("from_status")
  toStatus           String?  @map("to_status")
  actorId            String?  @map("actor_id")
  actorRoleCode      String?  @map("actor_role_code")
  note               String?
  metadata           Json?
  attachments        Json?
  suggestedAccountId String?  @map("suggested_account_id")
  finalAccountId     String?  @map("final_account_id")
  createdAt          DateTime @default(now()) @map("created_at")

  expenseRequest   ExpenseRequest @relation(fields: [expenseRequestId], references: [id], onDelete: Cascade)
  actor            User?          @relation(fields: [actorId], references: [id])
  suggestedAccount Account?       @relation("HistorySuggestedAccount", fields: [suggestedAccountId], references: [id])
  finalAccount     Account?       @relation("HistoryFinalAccount", fields: [finalAccountId], references: [id])

  @@index([expenseRequestId])
  @@index([createdAt])
  @@map("expense_request_histories")
}

// 付款排程任務
model PaymentTask {
  id               String    @id @default(uuid())
  entityId         String    @map("entity_id")
  expenseRequestId String?   @map("expense_request_id")
  accountId        String?   @map("account_id")
  vendorId         String?   @map("vendor_id")
  status           String    @default("pending")
  scheduledDate    DateTime? @map("scheduled_date")
  dueDate          DateTime? @map("due_date")
  paidDate         DateTime? @map("paid_date")
  amountOriginal   Decimal   @map("amount_original") @db.Decimal(18, 2)
  amountCurrency   String    @default("TWD") @map("amount_currency")
  amountFxRate     Decimal   @default(1) @map("amount_fx_rate") @db.Decimal(18, 6)
  amountBase       Decimal   @map("amount_base") @db.Decimal(18, 2)
  notes            String?
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  entity         Entity          @relation(fields: [entityId], references: [id], onDelete: Cascade)
  expenseRequest ExpenseRequest? @relation(fields: [expenseRequestId], references: [id], onDelete: SetNull)
  account        Account?        @relation(fields: [accountId], references: [id])
  vendor         Vendor?         @relation(fields: [vendorId], references: [id])

  @@index([entityId, status])
  @@map("payment_tasks")
}

// 智能科目建議的回饋紀錄
model AccountingClassifierFeedback {
  id                 String   @id @default(uuid())
  entityId           String   @map("entity_id")
  expenseRequestId   String?  @map("expense_request_id")
  description        String?
  suggestedAccountId String?  @map("suggested_account_id")
  chosenAccountId    String?  @map("chosen_account_id")
  suggestedItemId    String?  @map("suggested_item_id")
  chosenItemId       String?  @map("chosen_item_id")
  confidence         Decimal? @map("confidence") @db.Decimal(5, 2)
  label              String?
  features           Json?
  createdBy          String?  @map("created_by")
  createdAt          DateTime @default(now()) @map("created_at")

  entity           Entity             @relation("EntityClassifierFeedback", fields: [entityId], references: [id], onDelete: Cascade)
  expenseRequest  ExpenseRequest?     @relation(fields: [expenseRequestId], references: [id], onDelete: SetNull)
  createdByUser   User?               @relation(fields: [createdBy], references: [id])
  suggestedAccount Account?           @relation("ClassifierSuggestedAccount", fields: [suggestedAccountId], references: [id])
  chosenAccount     Account?          @relation("ClassifierChosenAccount", fields: [chosenAccountId], references: [id])
  suggestedItem     ReimbursementItem? @relation("FeedbackSuggestedItem", fields: [suggestedItemId], references: [id])
  chosenItem        ReimbursementItem? @relation("FeedbackChosenItem", fields: [chosenItemId], references: [id])

  @@index([entityId])
  @@index([expenseRequestId])
  @@map("accounting_classifier_feedbacks")
}

// 審核流程紀錄
model ApprovalRequest {
  id          String    @id @default(uuid())
  entityId    String    @map("entity_id")
  type        String // expense_request, payment, journal_entry, payroll_run
  refId       String    @map("ref_id") // 對應的單據 ID
  status      String    @default("pending") // pending, approved, rejected
  requestedBy String    @map("requested_by")
  approverId  String?   @map("approver_id")
  priority    String    @default("normal")
  remark      String?
  createdAt   DateTime  @default(now()) @map("created_at")
  approvedAt  DateTime? @map("approved_at")

  entity    Entity @relation(fields: [entityId], references: [id], onDelete: Cascade)
  requester User   @relation("RequesterUser", fields: [requestedBy], references: [id])
  approver  User?  @relation("ApproverUser", fields: [approverId], references: [id])

  @@index([entityId, status])
  @@index([type, refId])
  @@map("approval_requests")
}

// ============================================
// 6. 進貨與成本管理
// ============================================

// 進貨訂單
model PurchaseOrder {
  id        String   @id @default(uuid())
  entityId  String   @map("entity_id")
  vendorId  String   @map("vendor_id")
  orderDate DateTime @map("order_date")

  // 訂單總額（符合四欄位標準）
  totalAmountOriginal Decimal @map("total_amount_original") @db.Decimal(18, 2)
  totalAmountCurrency String  @default("TWD") @map("total_amount_currency")
  totalAmountFxRate   Decimal @default(1) @map("total_amount_fx_rate") @db.Decimal(18, 6)
  totalAmountBase     Decimal @map("total_amount_base") @db.Decimal(18, 2)

  status    String   @default("pending") // pending, received, completed, cancelled
  notes     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  entity         Entity              @relation(fields: [entityId], references: [id], onDelete: Cascade)
  vendor         Vendor              @relation(fields: [vendorId], references: [id])
  items          PurchaseOrderItem[]
  productBatches ProductBatch[]

  @@index([entityId, orderDate])
  @@map("purchase_orders")
}

// 進貨訂單明細
model PurchaseOrderItem {
  id              String  @id @default(uuid())
  purchaseOrderId String  @map("purchase_order_id")
  productId       String  @map("product_id")
  qty             Decimal @db.Decimal(18, 2)

  // 單位成本（符合四欄位標準）
  unitCostOriginal Decimal @map("unit_cost_original") @db.Decimal(18, 2)
  unitCostCurrency String  @default("TWD") @map("unit_cost_currency")
  unitCostFxRate   Decimal @default(1) @map("unit_cost_fx_rate") @db.Decimal(18, 6)
  unitCostBase     Decimal @map("unit_cost_base") @db.Decimal(18, 2)

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id])

  @@index([purchaseOrderId])
  @@map("purchase_order_items")
}

// 進貨批次（用於成本追蹤）
model ProductBatch {
  id              String  @id @default(uuid())
  entityId        String  @map("entity_id")
  productId       String  @map("product_id")
  purchaseOrderId String? @map("purchase_order_id")
  batchCode       String  @map("batch_code")
  qtyReceived     Decimal @map("qty_received") @db.Decimal(18, 2)

  // 單位成本（符合四欄位標準）
  unitCostOriginal Decimal @map("unit_cost_original") @db.Decimal(18, 6)
  unitCostCurrency String  @default("TWD") @map("unit_cost_currency")
  unitCostFxRate   Decimal @default(1) @map("unit_cost_fx_rate") @db.Decimal(18, 6)
  unitCostBase     Decimal @map("unit_cost_base") @db.Decimal(18, 6)

  receivedDate DateTime @map("received_date")
  createdAt    DateTime @default(now()) @map("created_at")

  entity        Entity         @relation(fields: [entityId], references: [id], onDelete: Cascade)
  product       Product        @relation(fields: [productId], references: [id])
  purchaseOrder PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])

  @@unique([entityId, batchCode])
  @@index([productId])
  @@map("product_batches")
}

// 開發成本（模具費、開發費、檢驗費攤提）
model DevCost {
  id        String  @id @default(uuid())
  entityId  String  @map("entity_id")
  productId String? @map("product_id")
  type      String // development, mold, certification

  // 開發成本金額（符合四欄位標準）
  amountOriginal Decimal @map("amount_original") @db.Decimal(18, 2)
  amountCurrency String  @default("TWD") @map("amount_currency")
  amountFxRate   Decimal @default(1) @map("amount_fx_rate") @db.Decimal(18, 6)
  amountBase     Decimal @map("amount_base") @db.Decimal(18, 2)

  allocationQty     Decimal  @map("allocation_qty") @db.Decimal(18, 2) // 預計攤提數量
  allocatedPerUnit  Decimal  @map("allocated_per_unit") @db.Decimal(18, 6) // 每單位攤提金額
  allocatedQtySoFar Decimal  @default(0) @map("allocated_qty_so_far") @db.Decimal(18, 2)
  status            String   @default("active") // active, fully_allocated
  notes             String?
  createdAt         DateTime @default(now()) @map("created_at")

  entity  Entity   @relation(fields: [entityId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])

  @@index([entityId, status])
  @@map("dev_costs")
}

// ============================================
// 7. 銀行與對帳管理
// ============================================

// 銀行帳戶
model BankAccount {
  id               String  @id @default(uuid())
  entityId         String  @map("entity_id")
  bankName         String  @map("bank_name")
  branch           String?
  accountNo        String  @map("account_no")
  currency         String  @default("TWD")
  isVirtualSupport Boolean @default(false) @map("is_virtual_support") // 是否支援虛擬帳號
  metaJson         Json?   @map("meta_json")
  isActive         Boolean @default(true) @map("is_active")

  entity           Entity            @relation(fields: [entityId], references: [id], onDelete: Cascade)
  virtualAccounts  VirtualAccount[]
  bankTransactions BankTransaction[]
  payments         Payment[]

  @@unique([entityId, accountNo])
  @@map("bank_accounts")
}

// 虛擬帳號
model VirtualAccount {
  id               String  @id @default(uuid())
  bankAccountId    String  @map("bank_account_id")
  virtualAccountNo String  @map("virtual_account_no")
  assignedToType   String? @map("assigned_to_type") // customer, order, ar_invoice
  assignedToId     String? @map("assigned_to_id")
  status           String  @default("active") // active, inactive

  bankAccount BankAccount @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)

  @@unique([bankAccountId, virtualAccountNo])
  @@map("virtual_accounts")
}

// 銀行交易流水（用於對帳）
model BankTransaction {
  id            String   @id @default(uuid())
  bankAccountId String   @map("bank_account_id")
  txnDate       DateTime @map("txn_date")
  valueDate     DateTime @map("value_date")

  // 交易金額（符合四欄位標準）
  amountOriginal Decimal @map("amount_original") @db.Decimal(18, 2)
  amountCurrency String  @default("TWD") @map("amount_currency")
  amountFxRate   Decimal @default(1) @map("amount_fx_rate") @db.Decimal(18, 6)
  amountBase     Decimal @map("amount_base") @db.Decimal(18, 2)

  descriptionRaw   String   @map("description_raw")
  referenceNo      String?  @map("reference_no")
  virtualAccountNo String?  @map("virtual_account_no")
  batchId          String?  @map("batch_id") // 關聯匯入批次
  matchedType      String?  @map("matched_type") // payment, ar_invoice, ap_invoice
  matchedId        String?  @map("matched_id")
  reconcileStatus  String   @default("unmatched") @map("reconcile_status") // unmatched, matched, partial, suspicious
  createdAt        DateTime @default(now()) @map("created_at")

  bankAccount          BankAccount           @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  importBatch          BankImportBatch?      @relation(fields: [batchId], references: [id])
  reconciliationResult ReconciliationResult?

  @@index([bankAccountId, txnDate])
  @@index([reconcileStatus])
  @@map("bank_transactions")
}

// ============================================
// 8. 人事與薪資管理
// ============================================

// 部門
model Department {
  id           String   @id @default(uuid())
  entityId     String   @map("entity_id")
  name         String
  costCenterId String?  @map("cost_center_id")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")

  entity          Entity           @relation(fields: [entityId], references: [id], onDelete: Cascade)
  employees       Employee[]
  expenseRequests ExpenseRequest[]
  approvalSteps   ApprovalStep[]

  @@map("departments")

  attendanceSchedules AttendanceSchedule[]
}

// 員工
model Employee {
  id            String    @id @default(uuid())
  entityId      String    @map("entity_id")
  userId        String?   @unique @map("user_id")
  employeeNo    String    @map("employee_no")
  name          String
  country       String // TW, CN
  location      String?
  departmentId  String?   @map("department_id")
  hireDate      DateTime  @map("hire_date")
  terminateDate DateTime? @map("terminate_date")

  // 薪資基數（符合四欄位標準）
  salaryBaseOriginal Decimal @map("salary_base_original") @db.Decimal(18, 2)
  salaryBaseCurrency String  @default("TWD") @map("salary_base_currency")
  salaryBaseFxRate   Decimal @default(1) @map("salary_base_fx_rate") @db.Decimal(18, 6)
  salaryBaseBase     Decimal @map("salary_base_base") @db.Decimal(18, 2)

  bankInfo  Json?    @map("bank_info")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  entity       Entity        @relation(fields: [entityId], references: [id], onDelete: Cascade)
  user         User?         @relation(fields: [userId], references: [id])
  department   Department?   @relation(fields: [departmentId], references: [id])
  payrollItems PayrollItem[]

  // Attendance Relations
  attendanceSchedules AttendanceSchedule[]
  attendanceRecords   AttendanceRecord[]
  attendanceSummaries AttendanceDailySummary[]
  leaveBalances       LeaveBalance[]
  leaveRequests       LeaveRequest[]
  attendanceAnomalies AttendanceAnomaly[]

  @@unique([entityId, employeeNo])
  @@index([entityId])
  @@map("employees")
}

// 薪資批次
model PayrollRun {
  id          String    @id @default(uuid())
  entityId    String    @map("entity_id")
  country     String // TW, CN
  periodStart DateTime  @map("period_start")
  periodEnd   DateTime  @map("period_end")
  payDate     DateTime  @map("pay_date")
  status      String    @default("draft") // draft, pending_approval, approved, posted
  createdBy   String    @map("created_by")
  approvedBy  String?   @map("approved_by")
  approvedAt  DateTime? @map("approved_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  entity   Entity        @relation(fields: [entityId], references: [id], onDelete: Cascade)
  creator  User          @relation("CreatedBy", fields: [createdBy], references: [id])
  approver User?         @relation("ApprovedBy", fields: [approvedBy], references: [id])
  items    PayrollItem[]

  @@index([entityId, country])
  @@map("payroll_runs")
}

// 薪資明細
model PayrollItem {
  id           String @id @default(uuid())
  payrollRunId String @map("payroll_run_id")
  employeeId   String @map("employee_id")
  type         String // BASE_SALARY, BONUS, ALLOWANCE, OVERTIME, INS_EMP_LABOR, INS_EMP_HEALTH, INS_COM_LABOR, INS_COM_HEALTH, INS_COM_PENSION, TAX_WITHHOLD

  // 薪資項目金額（符合四欄位標準）
  amountOriginal Decimal @map("amount_original") @db.Decimal(18, 2)
  amountCurrency String  @default("TWD") @map("amount_currency")
  amountFxRate   Decimal @default(1) @map("amount_fx_rate") @db.Decimal(18, 6)
  amountBase     Decimal @map("amount_base") @db.Decimal(18, 2)
  currency       String  @default("TWD")
  remark         String?

  payrollRun PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)
  employee   Employee   @relation(fields: [employeeId], references: [id])

  @@index([payrollRunId])
  @@index([employeeId])
  @@map("payroll_items")
}

// ============================================
// 13. 電子發票模組（Invoicing Module）
// ============================================

// 發票主表
model Invoice {
  id            String    @id @default(cuid())
  entityId      String    @map("entity_id")
  orderId       String?   @map("order_id") // 關聯 sales_orders
  invoiceNumber String    @unique @map("invoice_number") // 字軌 + 流水號（如：AA12345678）
  status        String    @default("draft") // draft, issued, void
  invoiceType   String    @default("B2C") @map("invoice_type") // B2C, B2B
  issuedAt      DateTime? @map("issued_at")
  voidAt        DateTime? @map("void_at")
  voidReason    String?   @map("void_reason")

  // 買方資訊
  buyerName    String? @map("buyer_name")
  buyerTaxId   String? @map("buyer_tax_id") // 統一編號（B2B 必填）
  buyerEmail   String? @map("buyer_email")
  buyerPhone   String? @map("buyer_phone")
  buyerAddress String? @map("buyer_address")

  // 發票金額（符合四欄位標準）
  amountOriginal Decimal @map("amount_original") @db.Decimal(18, 2) // 未稅金額
  currency       String  @default("TWD")
  fxRate         Decimal @default(1) @map("fx_rate") @db.Decimal(18, 6)
  amountBase     Decimal @map("amount_base") @db.Decimal(18, 2) // 未稅本位幣

  // 稅額（符合四欄位標準）
  taxAmountOriginal Decimal @default(0) @map("tax_amount_original") @db.Decimal(18, 2)
  taxAmountCurrency String  @default("TWD") @map("tax_amount_currency")
  taxAmountFxRate   Decimal @default(1) @map("tax_amount_fx_rate") @db.Decimal(18, 6)
  taxAmountBase     Decimal @default(0) @map("tax_amount_base") @db.Decimal(18, 2)

  // 總計（含稅）
  totalAmountOriginal Decimal @map("total_amount_original") @db.Decimal(18, 2)
  totalAmountCurrency String  @default("TWD") @map("total_amount_currency")
  totalAmountFxRate   Decimal @default(1) @map("total_amount_fx_rate") @db.Decimal(18, 6)
  totalAmountBase     Decimal @map("total_amount_base") @db.Decimal(18, 2)

  // 外部平台資訊
  externalInvoiceId String? @map("external_invoice_id") // 綠界/藍新等平台的發票 ID
  externalPlatform  String? @map("external_platform") // ecpay, newebpay, gov
  externalPayload   Json?   @map("external_payload") // 外部平台回傳的完整 payload

  notes     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  entity       Entity        @relation(fields: [entityId], references: [id], onDelete: Cascade)
  salesOrder   SalesOrder?   @relation(fields: [orderId], references: [id])
  invoiceLines InvoiceLine[]
  invoiceLogs  InvoiceLog[]

  @@index([entityId, status])
  @@index([orderId])
  @@index([invoiceNumber])
  @@index([issuedAt])
  @@map("invoices")
}

// 發票明細表
model InvoiceLine {
  id          String  @id @default(cuid())
  invoiceId   String  @map("invoice_id")
  productId   String? @map("product_id") // 可為 null（如運費、手續費）
  description String
  qty         Decimal @db.Decimal(18, 2)

  // 單價（符合四欄位標準）
  unitPriceOriginal Decimal @map("unit_price_original") @db.Decimal(18, 2)
  unitPriceCurrency String  @default("TWD") @map("unit_price_currency")
  unitPriceFxRate   Decimal @default(1) @map("unit_price_fx_rate") @db.Decimal(18, 6)
  unitPriceBase     Decimal @map("unit_price_base") @db.Decimal(18, 2)

  // 明細金額（符合四欄位標準）
  amountOriginal Decimal @map("amount_original") @db.Decimal(18, 2)
  currency       String  @default("TWD")
  fxRate         Decimal @default(1) @map("fx_rate") @db.Decimal(18, 6)
  amountBase     Decimal @map("amount_base") @db.Decimal(18, 2)

  // 稅額（符合四欄位標準）
  taxAmountOriginal Decimal @default(0) @map("tax_amount_original") @db.Decimal(18, 2)
  taxAmountCurrency String  @default("TWD") @map("tax_amount_currency")
  taxAmountFxRate   Decimal @default(1) @map("tax_amount_fx_rate") @db.Decimal(18, 6)
  taxAmountBase     Decimal @default(0) @map("tax_amount_base") @db.Decimal(18, 2)

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  invoice Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])

  @@index([invoiceId])
  @@map("invoice_lines")
}

// 發票操作記錄
model InvoiceLog {
  id        String   @id @default(cuid())
  invoiceId String   @map("invoice_id")
  action    String // issue, void, allowance, update
  userId    String   @map("user_id")
  payload   Json? // 操作時的資料快照
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  @@index([invoiceId])
  @@index([userId])
  @@map("invoice_logs")
}

// ============================================
// 14. 銀行對帳模組（Reconciliation Module）
// ============================================

// 銀行匯入批次
model BankImportBatch {
  id          String   @id @default(cuid())
  entityId    String   @map("entity_id")
  source      String // csv, json, bank-api (esun, ctbc, line-bank)
  importedBy  String   @map("imported_by")
  importedAt  DateTime @default(now()) @map("imported_at")
  fileName    String?  @map("file_name") // CSV 檔案名稱
  recordCount Int      @default(0) @map("record_count")
  notes       String?

  // Relations
  entity       Entity            @relation(fields: [entityId], references: [id], onDelete: Cascade)
  importer     User              @relation(fields: [importedBy], references: [id])
  transactions BankTransaction[]

  @@index([entityId, importedAt])
  @@map("bank_import_batches")
}

// 對帳結果表
model ReconciliationResult {
  id                String   @id @default(cuid())
  bankTransactionId String   @unique @map("bank_transaction_id")
  matchedType       String?  @map("matched_type") // sales_order, payment, ar_invoice, ap_invoice, unknown
  matchedId         String?  @map("matched_id") // 對應的業務單據 ID
  confidence        Int      @default(0) // 0~100 信心度
  ruleUsed          String?  @map("rule_used") // exact_amount, fuzzy_date, keyword, manual
  matchedAt         DateTime @default(now()) @map("matched_at")
  matchedBy         String?  @map("matched_by") // 如果是手動對帳，記錄操作人
  notes             String?

  // Relations
  bankTransaction BankTransaction @relation(fields: [bankTransactionId], references: [id], onDelete: Cascade)
  matcher         User?           @relation(fields: [matchedBy], references: [id])

  @@index([matchedType, matchedId])
  @@index([confidence])
  @@map("reconciliation_results")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  title     String
  message   String
  type      String   // e.g., 'info', 'success', 'warning', 'error'
  category  String   // e.g., 'expense', 'system', 'approval'
  read      Boolean  @default(false)
  data      Json?    // Store related entity ID, link, etc.
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id])

  @@map("notifications")
  @@index([userId])
  @@index([read])
}

// ============================================
// 9. 考勤與請假管理 (Attendance & Leave)
// ============================================

enum AttendanceMethod {
  MOBILE
  WEB
  KIOSK
}

enum AttendanceEventType {
  CLOCK_IN
  CLOCK_OUT
  BREAK_START
  BREAK_END
}

enum LeaveStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  CANCELLED
}

model AttendancePolicy {
  id             String   @id @default(uuid())
  entityId       String   @map("entity_id")
  name           String
  type           String   @default("office") // office, remote, hybrid
  ipAllowList    Json?    @map("ip_allow_list") // CIDR blocks
  geofence       Json?    // polygons or circle definitions
  requiresPhoto  Boolean  @default(false) @map("requires_photo")
  maxEarlyClock  Int      @default(15) @map("max_early_clock") // minutes before shift
  maxLateClock   Int      @default(5)  @map("max_late_clock")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  entity    Entity               @relation(fields: [entityId], references: [id], onDelete: Cascade)
  schedules AttendanceSchedule[]

  @@map("attendance_policies")
}

model AttendanceSchedule {
  id             String   @id @default(uuid())
  policyId       String   @map("policy_id")
  departmentId   String?  @map("department_id")
  employeeId     String?  @map("employee_id")
  weekday        Int      // 0=Sun ... 6=Sat
  shiftStart     String   @map("shift_start") // HH:mm, store as text for TZ simplicity
  shiftEnd       String   @map("shift_end")
  breakMinutes   Int      @default(60) @map("break_minutes")
  allowRemote    Boolean  @default(false) @map("allow_remote")
  createdAt      DateTime @default(now()) @map("created_at")

  policy     AttendancePolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)
  department Department?       @relation(fields: [departmentId], references: [id])
  employee   Employee?         @relation(fields: [employeeId], references: [id])

  attendanceRecords AttendanceRecord[]

  @@index([departmentId])
  @@index([employeeId])
  @@map("attendance_schedules")
}

model AttendanceRecord {
  id              String              @id @default(uuid())
  entityId        String              @map("entity_id")
  employeeId      String              @map("employee_id")
  scheduleId      String?             @map("schedule_id")
  eventType       AttendanceEventType @map("event_type")
  method          AttendanceMethod
  timestamp       DateTime
  latitude        Decimal? @db.Decimal(10, 6)
  longitude       Decimal? @db.Decimal(10, 6)
  ipAddress       String?  @map("ip_address")
  deviceInfo      Json?     @map("device_info")
  photoUrl        String?   @map("photo_url")
  isWithinFence   Boolean   @default(true) @map("is_within_fence")
  isWithinIpRange Boolean   @default(true) @map("is_within_ip_range")
  anomalyFlag     Boolean   @default(false) @map("anomaly_flag")
  notes           String?
  createdAt       DateTime  @default(now()) @map("created_at")

  entity   Entity        @relation(fields: [entityId], references: [id], onDelete: Cascade)
  employee Employee      @relation(fields: [employeeId], references: [id])
  schedule AttendanceSchedule? @relation(fields: [scheduleId], references: [id])
  anomalies AttendanceAnomaly[]

  @@index([entityId, employeeId, timestamp])
  @@index([anomalyFlag])
  @@map("attendance_records")
}

model AttendanceDailySummary {
  id             String   @id @default(uuid())
  entityId       String   @map("entity_id")
  employeeId     String   @map("employee_id")
  workDate       DateTime @map("work_date")
  clockInTime    DateTime? @map("clock_in_time")
  clockOutTime   DateTime? @map("clock_out_time")
  breakMinutes   Int       @default(0) @map("break_minutes")
  workedMinutes  Int       @default(0) @map("worked_minutes")
  overtimeMinutes Int      @default(0) @map("overtime_minutes")
  status         String    @default("pending") // pending, completed, missing_clock
  anomalyReason  String?   @map("anomaly_reason")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  entity   Entity   @relation(fields: [entityId], references: [id], onDelete: Cascade)
  employee Employee @relation(fields: [employeeId], references: [id])
  anomalies AttendanceAnomaly[]

  @@unique([entityId, employeeId, workDate])
  @@map("attendance_daily_summaries")
}

model LeaveType {
  id                 String   @id @default(uuid())
  entityId           String   @map("entity_id")
  code               String   // SICK, PERSONAL, ANNUAL, MENSTRUAL, MARRIAGE, FUNERAL, MATERNITY, PATERNITY, COMP_TIME, CUSTOM
  name               String
  requiresDocument   Boolean  @default(false) @map("requires_document")
  documentExamples   String?  @map("document_examples")
  maxDaysPerYear     Decimal? @map("max_days_per_year") @db.Decimal(5, 2)
  minNoticeHours     Int?     @map("min_notice_hours")
  paidPercentage     Decimal? @map("paid_percentage") @db.Decimal(5, 2)
  autoApprovalHours  Int?     @map("auto_approval_hours")
  approvalPolicyId   String?  @map("approval_policy_id")
  requiresChildData  Boolean  @default(false) @map("requires_child_data") // for maternity/paternity
  metadata           Json?
  isActive           Boolean  @default(true) @map("is_active")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  entity        Entity         @relation(fields: [entityId], references: [id], onDelete: Cascade)
  approvalPolicy ApprovalPolicy? @relation(fields: [approvalPolicyId], references: [id], onDelete: SetNull)
  leaveRequests  LeaveRequest[]
  leaveBalances  LeaveBalance[]

  @@unique([entityId, code])
  @@map("leave_types")
}

model LeaveBalance {
  id             String   @id @default(uuid())
  entityId       String   @map("entity_id")
  employeeId     String   @map("employee_id")
  leaveTypeId    String   @map("leave_type_id")
  year           Int
  accruedHours   Decimal @default(0) @map("accrued_hours") @db.Decimal(6, 2)
  usedHours      Decimal @default(0) @map("used_hours") @db.Decimal(6, 2)
  carryOverHours Decimal @default(0) @map("carry_over_hours") @db.Decimal(6, 2)
  pendingHours   Decimal @default(0) @map("pending_hours") @db.Decimal(6, 2)
  updatedAt      DateTime @updatedAt @map("updated_at")

  entity     Entity     @relation(fields: [entityId], references: [id], onDelete: Cascade)
  employee   Employee   @relation(fields: [employeeId], references: [id])
  leaveType  LeaveType  @relation(fields: [leaveTypeId], references: [id])

  @@unique([entityId, employeeId, leaveTypeId, year])
  @@map("leave_balances")
}

model LeaveRequest {
  id               String     @id @default(uuid())
  entityId         String     @map("entity_id")
  employeeId       String     @map("employee_id")
  leaveTypeId      String     @map("leave_type_id")
  startAt          DateTime   @map("start_at")
  endAt            DateTime   @map("end_at")
  hours            Decimal    @db.Decimal(5, 2)
  status           LeaveStatus @default(DRAFT)
  reviewerId       String?    @map("reviewer_id")
  reason           String?
  location         String?    // domestic, overseas, remote city
  requiredDocsMet  Boolean    @default(false) @map("required_docs_met")
  metadata         Json?
  createdAt        DateTime   @default(now()) @map("created_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")

  entity     Entity     @relation(fields: [entityId], references: [id], onDelete: Cascade)
  employee   Employee   @relation(fields: [employeeId], references: [id])
  leaveType  LeaveType  @relation(fields: [leaveTypeId], references: [id])
  reviewer   User?      @relation("LeaveReviewer", fields: [reviewerId], references: [id])
  documents  LeaveDocument[]
  histories  LeaveRequestHistory[]

  @@index([entityId, status])
  @@index([employeeId])
  @@map("leave_requests")
}

model LeaveDocument {
  id            String   @id @default(uuid())
  leaveRequestId String  @map("leave_request_id")
  fileName      String   @map("file_name")
  fileUrl       String   @map("file_url")
  mimeType      String   @map("mime_type")
  checksum      String?
  docType       String?  // medical_note, travel_itinerary, certificate
  uploadedBy    String   @map("uploaded_by")
  uploadedAt    DateTime @default(now()) @map("uploaded_at")

  leaveRequest LeaveRequest @relation(fields: [leaveRequestId], references: [id], onDelete: Cascade)
  uploader     User         @relation("LeaveDocumentUploader", fields: [uploadedBy], references: [id])

  @@map("leave_documents")
}

model LeaveRequestHistory {
  id             String   @id @default(uuid())
  leaveRequestId String   @map("leave_request_id")
  action         String
  fromStatus     LeaveStatus? @map("from_status")
  toStatus       LeaveStatus? @map("to_status")
  actorId        String?  @map("actor_id")
  note           String?
  metadata       Json?
  createdAt      DateTime @default(now()) @map("created_at")

  leaveRequest LeaveRequest @relation(fields: [leaveRequestId], references: [id], onDelete: Cascade)
  actor        User?        @relation("LeaveHistoryActor", fields: [actorId], references: [id])

  @@map("leave_request_histories")
}

model AttendanceAnomaly {
  id             String   @id @default(uuid())
  entityId       String   @map("entity_id")
  employeeId     String   @map("employee_id")
  summaryId      String?  @map("summary_id")
  recordId       String?  @map("record_id")
  type           String   // missing_clock, gps_mismatch, duplicate_ip, overtime_without_request
  severity       String   @default("medium")
  detectedAt     DateTime @default(now()) @map("detected_at")
  resolvedStatus String   @default("open") @map("resolved_status")
  resolverId     String?  @map("resolver_id")
  resolutionNote String?  @map("resolution_note")

  entity   Entity                 @relation(fields: [entityId], references: [id], onDelete: Cascade)
  employee Employee               @relation(fields: [employeeId], references: [id])
  summary  AttendanceDailySummary? @relation(fields: [summaryId], references: [id])
  record   AttendanceRecord?       @relation(fields: [recordId], references: [id])
  resolver User?                   @relation("AnomalyResolver", fields: [resolverId], references: [id])

  @@index([entityId, resolvedStatus])
  @@map("attendance_anomalies")
}
